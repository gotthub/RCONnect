apiVersion: v1
kind: Service
metadata:
  name: rcon
  namespace: minecraft
  labels:
    app: rconnect
spec:
  type: ClusterIP
  selector:
    app: rconnect
  ports:
    - name: http
      port: 80
      targetPort: web
    # Optional: expose backend internally too (handy for debugging/automation)
    - name: api
      port: 6304
      targetPort: api
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rconnect-config
  namespace: minecraft
data:
  # server 1
  server1_name: "bohnsdorfcraft-1"
  server1_ip: "bohnsdorfcraft-1-minecraft.minecraft.svc.cluster.local"
  server1_port: "25575"

  # server 2
  server2_name: "bohnsdorfcraft-ob"
  server2_ip: "bohnsdorfcraft-ob-minecraft.minecraft.svc.cluster.local"
  server2_port: "25576"

  # default selection
  default_selected: "login-bohnsdorfcraft-1.rconfig"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rconnect
  namespace: minecraft
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rconnect
  template:
    metadata:
      labels:
        app: rconnect
    spec:
      volumes:
        - name: rconnect-configuration
          emptyDir: {}

      initContainers:
        - name: generate-rconfig
          image: busybox:1.37
          securityContext:
            runAsUser: 0
          envFrom:
            - configMapRef:
                name: rconnect-config
          env:
            - name: RCON_PASSWORD_SERVER1
              valueFrom:
                secretKeyRef:
                  name: bohnsdorfcraft-1-minecraft-rcon
                  key: rcon-password
            - name: RCON_PASSWORD_SERVER2
              valueFrom:
                secretKeyRef:
                  name: bohnsdorfcraft-ob-minecraft-rcon
                  key: rcon-password
          volumeMounts:
            - name: rconnect-configuration
              mountPath: /out
          command: ["sh", "-lc"]
          args:
            - |
              set -eu

              cat > /out/login-${server1_name}.rconfig <<EOF
              # Login Info for RCONnect
              [ip; ${server1_ip}]
              [port; ${server1_port}]
              [password; ${RCON_PASSWORD_SERVER1}]
              EOF

              cat > /out/login-${server2_name}.rconfig <<EOF
              # Login Info for RCONnect
              [ip; ${server2_ip}]
              [port; ${server2_port}]
              [password; ${RCON_PASSWORD_SERVER2}]
              EOF

              # selector
              cat > /out/config.rconfig <<EOF
              # You can select config files here.
              [selected; ${default_selected}]
              EOF

              ls -la /out

      containers:
        - name: web
          image: ghcr.io/gotthub/rconnect-web:latest
          imagePullPolicy: Always
          ports:
            - name: web
              containerPort: 3000
          securityContext:
            runAsUser: 0
            allowPrivilegeEscalation: false
          env:
            # Helpful default so the UI can reach the backend in the same Pod
            # If the UI does not support this, ignore it; users can still enter the URL manually.
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
            - name: RCONNECT_BACKEND_URL
              value: "http://127.0.0.1:6304"
          readinessProbe:
            tcpSocket:
              port: web
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: web
            initialDelaySeconds: 15
            periodSeconds: 20
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

        - name: api
          image: ghcr.io/gotthub/rconnect-api:latest
          imagePullPolicy: Always
          ports:
            - name: api
              containerPort: 6304
          securityContext:
            runAsUser: 0
            allowPrivilegeEscalation: false
          env:
            # If server/index.js supports PORT, set it here. Otherwise remove.
            - name: PORT
              value: "6304"
          volumeMounts:
              - name: rconnect-configuration
                mountPath: /app/configuration
                readOnly: true
          readinessProbe:
            tcpSocket:
              port: api
            initialDelaySeconds: 3
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: api
            initialDelaySeconds: 10
            periodSeconds: 20
          resources:
            requests:
              cpu: 25m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 256Mi
